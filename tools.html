<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Discrete Distributions Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfbf7;
            color: #3f3c36;
        }
        .nav-button.active {
            background-color: #d4c8b0;
            color: #3f3c36;
            font-weight: 700;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        mjx-container {
            text-align: left !important;
            overflow-x: auto;
            overflow-y: hidden;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a89a81;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <nav class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-8 py-4 flex justify-between items-center">
            <a href="index.html" class="font-bold text-xl text-gray-900">Statistical Tools</a>
            <div>
                <a href="index.html" class="px-4 hover:text-blue-600">Home</a>
                <a href="tools.html" class="px-4 text-blue-600 font-semibold">Interactive Tools</a>
                <a href="guides.html" class="px-4 hover:text-blue-600">Guides</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <section id="explorer">
            <div id="dist-selector" class="flex flex-wrap gap-2 justify-center mb-8"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 bg-white/50 rounded-lg shadow-lg p-4 md:p-6 border border-gray-200/50">
                    <h3 id="chart-title" class="text-xl font-bold mb-4 text-center text-[#6a6355]"></h3>
                    <div class="chart-container">
                        <canvas id="pmfChart"></canvas>
                    </div>
                    <div id="param-controls" class="mt-8 space-y-4"></div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white/50 rounded-lg shadow-lg p-4 md:p-6 border border-gray-200/50">
                        <h3 class="text-xl font-bold mb-3 text-[#6a6355]">Mathematical Definition</h3>
                        <div id="math-details" class="space-y-3 text-sm md:text-base"></div>
                    </div>
                    <div class="bg-white/50 rounded-lg shadow-lg p-4 md:p-6 border border-gray-200/50">
                        <h3 class="text-xl font-bold mb-3 text-[#6a6355]">Application in Biology</h3>
                        <div id="app-details-container">
                             <p id="app-details" class="text-sm md:text-base leading-relaxed text-justify"></p>
                             <div id="gemini-output" class="hidden text-sm md:text-base leading-relaxed text-justify"></div>
                        </div>
                       
                        <div class="mt-4 pt-4 border-t border-gray-200/80">
                            <label for="custom-context" class="text-sm font-medium text-gray-700 block mb-2">Optional: Provide a topic for a new example.</label>
                            <input type="text" id="custom-context" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="e.g., cancer genomics, viral evolution...">
                            <button id="gemini-generate-btn" class="mt-3 w-full bg-[#a89a81] text-white font-bold py-2 px-4 rounded-md hover:bg-[#9a8c73] transition-colors flex items-center justify-center gap-2">
                                <span id="gemini-btn-text">✨ Generate Biological Scenario</span>
                                <div id="gemini-loader" class="loader hidden"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="text-center py-8 mt-12 border-t">
        <p class="text-sm text-gray-500">Statistical Tools for Modern Biology</p>
    </footer>

    <script>
        const distributionsData = {
            bernoulli: {
                name: 'Bernoulli',
                params: {
                    p: { name: 'p (Probability of Success)', min: 0, max: 1, step: 0.01, value: 0.5 }
                },
                pmf: (k, p) => (k === 1 ? p : (k === 0 ? 1 - p : 0)),
                pmf_latex: `P(X=k) = p^k(1-p)^{1-k}, \\quad k \\in \\{0, 1\\}`,
                mean_latex: `E[X] = p`,
                variance_latex: `Var(X) = p(1-p)`,
                app_text: `Models a single experiment with two outcomes (e.g., success/failure). In genetics, it's fundamental for modeling the state of a bi-allelic Single Nucleotide Polymorphism (SNP), where 'success' might represent the presence of a minor allele. The parameter 'p' corresponds to the minor allele frequency (MAF) in the population.`
            },
            binomial: {
                name: 'Binomial',
                params: {
                    n: { name: 'n (Number of Trials)', min: 1, max: 100, step: 1, value: 20 },
                    p: { name: 'p (Probability of Success)', min: 0, max: 1, step: 0.01, value: 0.5 }
                },
                pmf: (k, n, p) => {
                    if (k < 0 || k > n) return 0;
                    const logFactorial = x => {
                        let l = 0;
                        for (let i = 2; i <= x; i++) l += Math.log(i);
                        return l;
                    };
                    const logC = logFactorial(n) - logFactorial(k) - logFactorial(n-k);
                    return Math.exp(logC + k * Math.log(p) + (n - k) * Math.log(1 - p));
                },
                pmf_latex: `P(X=k) = \\binom{n}{k} p^k (1-p)^{n-k}`,
                mean_latex: `E[X] = np`,
                variance_latex: `Var(X) = np(1-p)`,
                app_text: `Models the total number of successes in 'n' independent Bernoulli trials. It's widely used in population genetics to model the number of individuals in a sample carrying a specific allele, assuming the population is large and sampling is random. It also models outcomes in replicate experiments.`
            },
            poisson: {
                name: 'Poisson',
                params: {
                    lambda: { name: '\\(\\lambda\\) (Rate)', min: 0.1, max: 30, step: 0.1, value: 5 }
                },
                pmf: (k, lambda) => {
                    const logFactorial = x => {
                        let l = 0;
                        for (let i = 2; i <= x; i++) l += Math.log(i);
                        return l;
                    };
                    return Math.exp(k * Math.log(lambda) - lambda - logFactorial(k));
                },
                pmf_latex: `P(X=k) = \\frac{\\lambda^k e^{-\\lambda}}{k!}`,
                mean_latex: `E[X] = \\lambda`,
                variance_latex: `Var(X) = \\lambda`,
                app_text: `Models the number of events occurring in a fixed interval of time or space, given a constant average rate (\\(\\lambda\\)). A foundational model for mutation counts in a DNA region over time or for the number of sequencing reads mapping to a genomic window under a null hypothesis of random distribution.`
            },
            negative_binomial: {
                name: 'Negative Binomial',
                params: {
                    r: { name: 'r (Number of Successes)', min: 1, max: 50, step: 1, value: 10 },
                    p: { name: 'p (Probability of Success)', min: 0.01, max: 1, step: 0.01, value: 0.5 }
                },
                pmf: (k, r, p) => {
                    if (k < 0) return 0;
                     const logFactorial = x => {
                        let l = 0;
                        for (let i = 2; i <= x; i++) l += Math.log(i);
                        return l;
                    };
                    const logGamma = x => logFactorial(x-1);
                    const logC = logGamma(k + r) - logGamma(k + 1) - logGamma(r);
                    return Math.exp(logC + r * Math.log(p) + k * Math.log(1 - p));
                },
                pmf_latex: `P(X=k) = \\binom{k+r-1}{k} p^r (1-p)^k`,
                mean_latex: `E[X] = \\frac{r(1-p)}{p}`,
                variance_latex: `Var(X) = \\frac{r(1-p)}{p^2}`,
                app_text: `Models the number of failures before 'r' successes occur. Crucially, it handles overdispersed count data (where variance > mean), a common feature of biological data. It is the standard distribution for differential gene expression analysis in RNA-seq (e.g., in DESeq2, edgeR) to account for biological variability.`
            }
        };

        let currentDistribution = 'binomial';
        let pmfChart;

        const distSelector = document.getElementById('dist-selector');
        const chartTitle = document.getElementById('chart-title');
        const paramControls = document.getElementById('param-controls');
        const mathDetails = document.getElementById('math-details');
        const appDetails = document.getElementById('app-details');
        const geminiOutput = document.getElementById('gemini-output');
        const geminiGenerateBtn = document.getElementById('gemini-generate-btn');
        const geminiBtnText = document.getElementById('gemini-btn-text');
        const geminiLoader = document.getElementById('gemini-loader');
        const customContextInput = document.getElementById('custom-context');
        const ctx = document.getElementById('pmfChart').getContext('2d');

        function createControls() {
            paramControls.innerHTML = '';
            const dist = distributionsData[currentDistribution];
            for (const [param, config] of Object.entries(dist.params)) {
                const controlDiv = document.createElement('div');
                const label = document.createElement('label');
                label.innerHTML = `${config.name}: <span id="${param}-value">${config.value}</span>`;
                label.htmlFor = `${param}-slider`;
                label.className = "block mb-1 text-sm font-medium";

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.id = `${param}-slider`;
                slider.min = config.min;
                slider.max = config.max;
                slider.step = config.step;
                slider.value = config.value;
                slider.className = "w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer";

                slider.addEventListener('input', (e) => {
                    dist.params[param].value = parseFloat(e.target.value);
                    document.getElementById(`${param}-value`).textContent = dist.params[param].value;
                    updateView();
                });
                
                controlDiv.appendChild(label);
                controlDiv.appendChild(slider);
                paramControls.appendChild(controlDiv);
            }
        }

        function updateView() {
            const dist = distributionsData[currentDistribution];
            chartTitle.textContent = `${dist.name} Distribution PMF`;
            
            mathDetails.innerHTML = `
                <p><strong>PMF:</strong> \\(${dist.pmf_latex}\\)</p>
                <p><strong>Mean:</strong> \\(${dist.mean_latex}\\)</p>
                <p><strong>Variance:</strong> \\(${dist.variance_latex}\\)</p>
            `;
            
            appDetails.textContent = dist.app_text;
            appDetails.classList.remove('hidden');
            geminiOutput.classList.add('hidden');

            if (window.MathJax) {
                MathJax.typesetPromise([mathDetails]);
            }

            updateChart();
        }

        function updateChart() {
            const dist = distributionsData[currentDistribution];
            const params = Object.values(dist.params).map(p => p.value);

            let labels, data;
            
            if (currentDistribution === 'bernoulli') {
                labels = [0, 1];
                data = labels.map(k => dist.pmf(k, ...params));
            } else {
                let max_k;
                if (currentDistribution === 'binomial') max_k = params[0];
                else if (currentDistribution === 'poisson') max_k = Math.max(20, Math.ceil(params[0] * 2.5));
                else if (currentDistribution === 'negative_binomial') max_k = Math.max(30, Math.ceil(dist.params.r.value * (1-dist.params.p.value)/dist.params.p.value * 3));
                else max_k = 30;

                labels = Array.from({ length: Math.min(max_k + 1, 101) }, (_, i) => i);
                data = labels.map(k => dist.pmf(k, ...params));
            }

            pmfChart.data.labels = labels;
            pmfChart.data.datasets[0].data = data;
            pmfChart.data.datasets[0].label = `${dist.name} PMF`;
            pmfChart.options.scales.x.title.text = (currentDistribution === 'negative_binomial') ? 'k (Number of Failures)' : 'k (Number of Events/Successes)';
            pmfChart.update();
        }

        async function generateScenario() {
            geminiBtnText.textContent = "Generating...";
            geminiLoader.classList.remove('hidden');
            geminiGenerateBtn.disabled = true;

            const dist = distributionsData[currentDistribution];
            const customContext = customContextInput.value.trim();
            const paramString = Object.entries(dist.params).map(([key, val]) => `${key}=${val.value}`).join(', ');

            let prompt = `As an expert in computational biology, provide a clear, concise, and novel example of how the ${dist.name} distribution is used.
            The current parameters are: ${paramString}.
            Explain the scenario and how the parameters relate to it.`;
            
            if (customContext) {
                prompt += ` Focus the example on the topic of: "${customContext}".`;
            } else {
                prompt += ` The example should be different from the standard textbook cases.`;
            }
            prompt += ` Keep the explanation to about 2-3 paragraphs.`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    appDetails.classList.add('hidden');
                    geminiOutput.innerHTML = text.replace(/\n/g, '<br><br>') + '<p class="text-xs text-gray-500 mt-2"><em>Content generated by Gemini.</em></p>';
                    geminiOutput.classList.remove('hidden');
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                geminiOutput.innerHTML = `<p class="text-red-500">Sorry, something went wrong while generating the example. Please try again.</p>`;
                geminiOutput.classList.remove('hidden');
                appDetails.classList.add('hidden');
                console.error("Gemini API Error:", error);
            } finally {
                geminiBtnText.textContent = "✨ Generate Biological Scenario";
                geminiLoader.classList.add('hidden');
                geminiGenerateBtn.disabled = false;
            }
        }
        
        function initialize() {
            Object.keys(distributionsData).forEach(key => {
                const button = document.createElement('button');
                button.textContent = distributionsData[key].name;
                button.dataset.dist = key;
                button.className = "nav-button px-4 py-2 text-sm rounded-md transition-colors duration-200 ease-in-out bg-[#f6f3ed] hover:bg-[#e9e2d5]";
                if (key === currentDistribution) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => {
                    currentDistribution = key;
                    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    createControls();
                    updateView();
                });
                distSelector.appendChild(button);
            });

            pmfChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '',
                        data: [],
                        backgroundColor: '#a89a81',
                        borderColor: '#8c8577',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Probability' }},
                        x: { title: { display: true, text: 'k' }}
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += context.parsed.y.toPrecision(4); }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            geminiGenerateBtn.addEventListener('click', generateScenario);
            createControls();
            updateView();
        }

        window.onload = initialize;
    </script>
</body>
</html>
